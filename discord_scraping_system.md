# üß† Discord Message Scraping System Architecture

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (—Å–∫—Ä–∞–ø–∏–Ω–≥–∞) –≤ –±–æ—Ç–µ. –°–∏—Å—Ç–µ–º–∞ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–∫, —á—Ç–æ–±—ã –±—ã—Ç—å **–∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π, "—É–º–Ω–æ–π" –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π**.

## üîÑ –û–±—â–∞—è —Å—Ö–µ–º–∞ (High-Level Flow)

```mermaid
graph TD
    A[ü§ñ Bot Startup] -->|Check Config| B{Scrape Enabled?}
    B -->|Yes| C[üöÄ Start Background Task]
    B -->|No| Z[üí§ Idle]
    
    C --> D[üìÇ Load ScraperProgress]
    D --> E{Has History?}
    
    E -->|No (First Run)| F[üìå Initialize: Find Latest Message ID]
    E -->|Yes (Resume)| G[‚è≠Ô∏è Load Last Scraped ID]
    
    F --> H[üì• Fetch NEW Messages (History API)]
    G --> H
    
    H --> I{Filter Messages}
    I -->|Bot/Empty| J[üóëÔ∏è Skip]
    I -->|Valid| K[üì¶ Add to Batch]
    
    K --> L{Batch Full?}
    L -->|Yes| M[üíæ Bulk Insert to SQLite]
    L -->|No| H
    
    M --> N[üìù Update Progress File]
    N --> H
```

---

## üõ†Ô∏è –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∏ –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å
–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É. –û–Ω–∞ —É–º–Ω–∞—è: –æ–Ω–∞ –Ω–µ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å –≤—Å—ë —Å—Ä–∞–∑—É, –∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–±–æ—Ç—É –ø–æ –∫–∞–Ω–∞–ª–∞–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ —É–ø–µ—Ä–µ—Ç—å—Å—è –≤ –ª–∏–º–∏—Ç—ã Discord API.

**–§–∞–π–ª:** `src/bot/client.py`

```python
async def _background_message_scraper(self):
    # 1. –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ—Ç–∞
    await asyncio.sleep(5)
    
    # 2. –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∫–∞–Ω–∞–ª—ã
    for guild in self.guilds:
        # ... (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –≥–∏–ª—å–¥–∏–π)
        
        # 3. –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π —Å–∫—Ä–∞–ø–∏–Ω–≥ (–ø–æ N –∫–∞–Ω–∞–ª–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
        if valid_channels:
            max_parallel = self.config.auto_indexing.parallel_channels
            semaphore = asyncio.Semaphore(max_parallel)
            
            # Scrape channels in parallel
            await asyncio.gather(*[scrape_with_limit(ch) for ch in valid_channels])
```

### 2. "–£–º–Ω—ã–π" –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –°–±–æ—Ä (Smart Resume)
–°–∞–º–∞—è –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å. –ë–æ—Ç –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –æ–Ω –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–∫–∞—á–∏–≤–∞—Ç—å **—Å—Ç—Ä–æ–≥–æ –ø–æ—Å–ª–µ** —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º—ã –Ω–µ –∫–∞—á–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –Ω–µ —Ç—Ä–∞—Ç–∏–º –≤—Ä–µ–º—è –∑—Ä—è.

**–§–∞–π–ª:** `src/bot/client.py`

```python
async def _scrape_channel_history(self, channel, limit=None):
    # 1. –ó–∞–≥—Ä—É–∂–∞–µ–º, –Ω–∞ —á–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑
    last_message_id = self.scraper_progress.get_last_message_id(channel_id)
    
    # 2. –§–æ—Ä–º–∏—Ä—É–µ–º "–º–∞—Ä–∫–µ—Ä" (Object), –ø–æ—Å–ª–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–∞–¥–æ –∏—Å–∫–∞—Ç—å
    after = discord.Object(id=int(last_message_id)) if last_message_id else None
    
    # 3. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —É Discord —Ç–æ–ª—å–∫–æ –ù–û–í–´–ï —Å–æ–æ–±—â–µ–Ω–∏—è (after=...)
    # oldest_first=False –æ–∑–Ω–∞—á–∞–µ—Ç "–∏–¥–µ–º –æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º", –Ω–æ —Å after –º—ã –∏–¥–µ–º "–≤–ø–µ—Ä–µ–¥" –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ
    async for message in channel.history(limit=limit, oldest_first=False, after=after):
        # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
```

### 3. –¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (Progress Tracker)
–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ JSON —Ñ–∞–π–ª. –î–∞–∂–µ –µ—Å–ª–∏ –±–æ—Ç —É–ø–∞–¥–µ—Ç, –æ–Ω "–≤—Å–ø–æ–º–Ω–∏—Ç", –≥–¥–µ –±—ã–ª.

**–§–∞–π–ª:** `src/utils/scraper_progress.py`

```python
class ScraperProgress:
    def update_progress(self, channel_id, last_message_id, ...):
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
        self.progress[channel_id].update({
            "last_message_id": last_message_id,
            "last_scraped": datetime.utcnow().isoformat(),
        })
        
        # –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –¥–∏—Å–∫, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–∞–Ω–Ω—ã–µ
        self._save_progress()
```

### 4. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –≠–∫–æ–Ω–æ–º–∏—è (Batching + No AI Costs)
–°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–∞—á–∫–∞–º–∏ (–±–∞—Ç—á–∞–º–∏) –ø–æ 50-100 —à—Ç—É–∫, —á—Ç–æ–±—ã –Ω–µ –¥–µ—Ä–≥–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
**–í–∞–∂–Ω–æ:** –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite, –∞ –Ω–µ –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ (Qdrant), —á—Ç–æ —ç–∫–æ–Ω–æ–º–∏—Ç –æ–≥—Ä–æ–º–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –Ω–∞ OpenAI API (—Ç–∞–∫ –∫–∞–∫ –Ω–µ –Ω—É–∂–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å embeddings –¥–ª—è –∫–∞–∂–¥–æ–≥–æ "–ø—Ä–∏–≤–µ—Ç").

**–§–∞–π–ª:** `src/bot/client.py`

```python
# –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –±–∞—Ç—á
message_batch.append(message)

# –ï—Å–ª–∏ –±–∞—Ç—á –ø–æ–ª–æ–Ω - —Å–æ—Ö—Ä–∞–Ω—è–µ–º
if len(message_batch) >= BATCH_SIZE:
    # –ú–µ—Ç–æ–¥ store_messages_batch –¥–µ–ª–∞–µ—Ç –æ–¥–∏–Ω –±—ã—Å—Ç—Ä—ã–π INSERT —Å—Ä–∞–∑—É –¥–ª—è 100 —Å–æ–æ–±—â–µ–Ω–∏–π
    indexed_count += await self._index_message_batch(
        message_batch, channel_id, channel_name
    )
    message_batch = [] # –û—á–∏—â–∞–µ–º
```

## ‚ö° –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä—É—Ç–æ —Å–¥–µ–ª–∞–Ω–æ?

1.  **–ù–µ—É–±–∏–≤–∞–µ–º–æ—Å—Ç—å**: –ú–æ–∂–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞ –Ω–∞ –Ω–µ–¥–µ–ª—é. –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –æ–Ω –ø—Ä–æ—Å—Ç–æ "–¥–æ–∫–∞—á–∞–µ—Ç" –≤—Å—ë, —á—Ç–æ –ø—Ä–æ–ø—É—Å—Ç–∏–ª –∑–∞ –Ω–µ–¥–µ–ª—é, –Ω–∞—á–∏–Ω–∞—è —Å —Ç–æ–π –∂–µ —Å–µ–∫—É–Ω–¥—ã.
2.  **–°–∫–æ—Ä–æ—Å—Ç—å**: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–µ—Ç–∏ –ø–æ –º–∞–∫—Å–∏–º—É–º—É.
3.  **–ë–µ—Å–ø–ª–∞—Ç–Ω–æ—Å—Ç—å**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (SQLite) –≤–º–µ—Å—Ç–æ –¥–æ—Ä–æ–≥–∏—Ö –æ–±–ª–∞—á–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏.
